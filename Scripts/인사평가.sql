/* 인사평가질문 */
DROP TABLE appraisalQue CASCADE CONSTRAINTS;

/* 인사평가질문 */
CREATE TABLE appraisalQue (
	Queno NUMBER PRIMARY KEY, /* 질문번호 */
	question VARCHAR2(100) NOT NULL /* 질문 */
);

/* 인사평가답변 */
DROP TABLE appraisalAnswer CASCADE CONSTRAINTS;

/* 인사평가답변 */
CREATE TABLE appraisalAnswer (
	Queno NUMBER, /* 질문번호 */
	point NUMBER, /* 점수 */
	sub CHAR(10), /* 답변자 */
	obj CHAR(10) /* 피평가자 */
);
ALTER TABLE appraisalAnswer ADD PRIMARY KEY (Queno,sub,obj);
ALTER TABLE appraisalAnswer ADD FOREIGN KEY ( Queno ) REFERENCES appraisalQue (Queno);
ALTER TABLE appraisalAnswer ADD FOREIGN KEY ( sub ) REFERENCES Employee (EMPNO);
ALTER TABLE appraisalAnswer ADD FOREIGN KEY ( obj ) REFERENCES Employee (EMPNO);
ALTER TABLE appraisalAnswer ADD CHECK (point BETWEEN 1 AND 5)  ;

SELECT * FROM EMPLOYEE e ;
SELECT * FROM DEPARTMENT d  ;
SELECT * FROM appraisalQue ;
SELECT * FROM APPRAISALANSWER;

--질문 입력할때
--INSERT INTO appraisalQue VALUES (2021||seqforAppraQ.nextval ,'업무 협조도');
--INSERT INTO appraisalQue VALUES (2021||seqforAppraQ.nextval ,'업무시간 준수 정도');
--INSERT INTO appraisalQue VALUES (2021||seqforAppraQ.nextval ,'업무 외 태도');

--답변할때
INSERT INTO APPRAISALANSWER VALUES (20228,4,2022701025,2022101001) ;
INSERT INTO APPRAISALANSWER VALUES (20224,3,2022701025,2022101001) ;
INSERT INTO APPRAISALANSWER VALUES (20225,1,2022701025,2022101001) ;
INSERT INTO APPRAISALANSWER VALUES (20226,5,2022701025,2022101001) ;
INSERT INTO APPRAISALANSWER VALUES (20227,4,2022701025,2022101001) ;

INSERT INTO APPRAISALANSWER VALUES (20219,5,2022701025,2022201020) ;
INSERT INTO APPRAISALANSWER VALUES (202110,3,2022701025,2022201020) ;
INSERT INTO APPRAISALANSWER VALUES (202111,2,2022701025,2022201020) ;
INSERT INTO APPRAISALANSWER VALUES (20227,5,2022701025,2022201020) ;

INSERT INTO APPRAISALANSWER VALUES (20224,5,2022201023,2022301022) ;
INSERT INTO APPRAISALANSWER VALUES (20225,3,2022201023,2022301022) ;
INSERT INTO APPRAISALANSWER VALUES (20226,1,2022201023,2022301022) ;
INSERT INTO APPRAISALANSWER VALUES (20227,2,2022201023,2022301022) ;
DELETE FROM appraisalanswer WHERE OBJ=2022101026;
--UPDATE appraisalQue SET QUESTION ='업무 방향성을 명확히 제시하는가' WHERE queno=20227;

--e2의 평가결과
SELECT e2.NAME, QUEstion, point, e.name "평가자" FROM APPRAISALQUE aq, APPRAISALANSWER aa, EMPLOYEE e, EMPLOYEE e2  WHERE aq.Queno=aa.QUENO AND e.EMPNO = aa.SUB AND e2.EMPNO = aa.obj AND obj=2022101026;

--사람별 평균점수
SELECT name, ROUND(avg(point),3) FROM APPRAISALANSWER aa, EMPLOYEE e WHERE aa.OBJ =e.EMPNO AND OBJ=2022201023 GROUP BY name ;

--내 평균점수 연도설정
SELECT ROUND(avg(point),3) FROM APPRAISALANSWER aa,EMPLOYEE e  WHERE aa.OBJ =e.EMPNO AND name = '김곽칠' AND substr(queno,1,4)=2022 GROUP BY OBJ  ;

--사람별/항목별 평균 점수
SELECT obj, queno,ROUND(avg(point),3) FROM APPRAISALANSWER aa GROUP BY obj, QUENO ;
--사람별/항목별 이름 나오게 평균점수
SELECT DISTINCT name, question , 평균점수 
FROM appraisalQue Q, EMPLOYEE e ,(SELECT obj, queno, ROUND(avg(point),3) "평균점수" FROM APPRAISALANSWER aa GROUP BY obj, QUENO) "그룹테이블" 
WHERE q.queno=그룹테이블.queno AND 그룹테이블.obj = e.empno AND name = '김박박';

----사람별/항목별 이름 나오게 평균점수+연도별
SELECT DISTINCT name, question , 평균점수 FROM appraisalQue Q, EMPLOYEE e ,(SELECT obj, queno, ROUND(avg(point),3) "평균점수" 
FROM APPRAISALANSWER aa GROUP BY obj, QUENO) "그룹테이블" WHERE q.queno=그룹테이블.queno AND 그룹테이블.obj = e.empno AND name = '김곽칠' AND substr(q.queno,1,4)=2021;

--부서별 총 평균 점수
SELECT dname, ROUND(avg(point),3)  FROM APPRAISALANSWER a , EMPLOYEE e,DEPARTMENT d  WHERE e.EMPNO =a.OBJ AND d.DEPTNO =e.DEPTNO AND dname LIKE '%'||''||'%' AND substr(queno,1,4) LIKE '%'||''||'%'  GROUP BY dname ;

--부서별 항목별 점수
SELECT dname, question , ROUND(avg(point),3)  FROM APPRAISALANSWER a , EMPLOYEE e,DEPARTMENT d, APPRAISALQUE aq 
WHERE e.EMPNO =a.OBJ AND d.DEPTNO =e.DEPTNO AND aq.QUENO =a.QUENO AND dname LIKE '%'||''||'%' AND substr(aq.QUENO,1,4)=2022 GROUP BY dname, Question ORDER BY dname  ;

--2022년도 질문만
SELECT * FROM APPRAISALQUE a  WHERE substr(queno,1,4)=2022
AND NOT EXISTS( SELECT * FROM APPRAISALANSWER a WHERE sub=2022101026 AND obj =2022101001 AND queno =20228);
--나랑 같은 부서 사람들(나 빼고)
select name from employee where deptno = 40 AND empno <> 2022101001 ;
--이사람이 문제랑 obj에 없을때
INSERT INTO APPRAISALANSWER (SELECT 문제번호,점수,내번호,대상자 FROM DUAL 
	WHERE NOT EXISTS ( SELECT * FROM APPRAISALANSWER a WHERE sub= 내번호 AND obj = 대상자 AND queno = 문제번호));
	
